<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Let Your Database Update You with EctoWatch - brian-underwood.blogs</title>
<meta name="description" content="Elixir allows application developers to create very parallel and very complex systems. Tools like Phoenix PubSub and LiveView thrive on this property of the language, making it very easy to develop functionality that requires continuous updates to users and clients.">


  <meta name="author" content="Brian Underwood">
  
  <meta property="article:author" content="Brian Underwood">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="brian-underwood.blogs">
<meta property="og:title" content="Let Your Database Update You with EctoWatch">
<meta property="og:url" content="https://www.erlang-solutions.com/blog/let-your-database-update-you-with-ectowatch/">


  <meta property="og:description" content="Elixir allows application developers to create very parallel and very complex systems. Tools like Phoenix PubSub and LiveView thrive on this property of the language, making it very easy to develop functionality that requires continuous updates to users and clients.">







  <meta property="article:published_time" content="2024-06-27T00:00:00+02:00">






<link rel="canonical" href="https://www.erlang-solutions.com/blog/let-your-database-update-you-with-ectowatch/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="brian-underwood.blogs Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <link rel="stylesheet" href="/assets/css/custom.css">
<link rel="stylesheet" href="/assets/prism.css">
<link rel="stylesheet" href="/assets/site.css">

<script defer src="/assets/js/alpine-3.2.1.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300&family=Raleway:ital,wght@0,200;0,500;0,700;1,200;1,500;1,700&display=swap" rel="stylesheet">
 <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300&family=Playfair+Display:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          brian-underwood.blogs
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/bio-photo.png" alt="Brian Underwood" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Brian Underwood</h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Stockholm, Sweden</span>
        </li>
      

      
        
          
            <li><a href="http://www.brian-underwood.codes/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">brian-underwood.codes</span></a></li>
          
        
          
            <li><a href="https://twitter.com/cheerfulstoic" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">cheerfulstoic</span></a></li>
          
        
          
            <li><a href="https://github.com/cheerfulstoic" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github-square" aria-hidden="true"></i><span class="label">cheerfulstoic</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Let Your Database Update You with EctoWatch">
    <meta itemprop="description" content="Elixir allows application developers to create very parallel and very complex systems. Tools like Phoenix PubSub and LiveView thrive on this property of the language, making it very easy to develop functionality that requires continuous updates to users and clients.">
    <meta itemprop="datePublished" content="2024-06-27T00:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Let Your Database Update You with EctoWatch
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2024-06-27T00:00:00+02:00">June 27, 2024</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Elixir allows application developers to create very parallel and very complex systems. Tools like Phoenix PubSub and LiveView thrive on this property of the language, making it very easy to develop functionality that requires continuous updates to users and clients.</p>

<p>But one thing that has often frustrated me is how to cleanly design an application to respond to database record updates.</p>

<p>A typical pattern that I’ve used is to have a dedicated function which makes a database change (e.g <code class="language-plaintext highlighter-rouge">Shipping.insert_event</code>). This function can contain a post-update step which sends out, for example, a PubSub broadcast. But this relies on the team using that function consistently. If there are other update functions (e.g. <code class="language-plaintext highlighter-rouge">Shipping.insert_delivery</code>) they also need to do the broadcast.</p>

<p>But the most fool-proof solution would be to have the <strong>database</strong> update the <strong>application</strong> whenever there is a change. Not only would this avoid needing to make sure all update functions send out broadcasts, but it also makes sure that the correct actions are taken whenever some external task or application updates the database directly.</p>

<p>While I knew that PostgreSQL had functionality to inform my applications about updates it always seemed intimidating. So I finally decided to figure out how it worked and to make a library! I’d like to introduce EctoWatch which is my attempt to implement this pattern in the simplest way possible.</p>

<h1 id="why-broadcast-database-updates">Why Broadcast Database Updates?</h1>

<p>Aside from the obvious case of updating LiveViews, there are a number of things you might want to do in response to record changes:</p>

<ul>
  <li>redoing a calculation/cache when source information changes</li>
  <li>sending out emails about a change</li>
  <li>sending out webhook requests</li>
  <li>updating a GraphQL subscription</li>
</ul>

<p>For example, if you insert a new status event for a tracked package, you may want to:</p>

<ul>
  <li>update any webpages/applications currently tracking the package</li>
  <li>send updates about important events (like the package being delivered)</li>
  <li>recalculate and update the estimated delivery date</li>
</ul>

<h1 id="using-ectowatch">Using EctoWatch</h1>

<p>EctoWatch allows you to set up watchers in your application’s supervision tree which can track inserts, updates, and deletes on Ecto schemas which are backed by PostgreSQL tables:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">EctoWatch</span><span class="p">,</span>
  <span class="ss">repo:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Repo</span><span class="p">,</span>
  <span class="ss">pub_sub:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">PubSub</span><span class="p">,</span>
  <span class="ss">watchers:</span> <span class="p">[</span>
    <span class="p">{</span><span class="no">Accounts</span><span class="o">.</span><span class="no">User</span><span class="p">,</span> <span class="ss">:inserted</span><span class="p">},</span>
    <span class="p">{</span><span class="no">Accounts</span><span class="o">.</span><span class="no">User</span><span class="p">,</span> <span class="ss">:updated</span><span class="p">},</span>
    <span class="p">{</span><span class="no">Accounts</span><span class="o">.</span><span class="no">User</span><span class="p">,</span> <span class="ss">:deleted</span><span class="p">},</span>
    <span class="p">{</span><span class="no">Shipping</span><span class="o">.</span><span class="no">Package</span><span class="p">,</span> <span class="ss">:inserted</span><span class="p">},</span>
    <span class="p">{</span><span class="no">Shipping</span><span class="o">.</span><span class="no">Package</span><span class="p">,</span> <span class="ss">:updated</span><span class="p">}</span>
  <span class="p">]}</span>
</code></pre></div></div>

<p>Then processes can subscribe to the broadcasts sent by the watchers:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">EctoWatch</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Accounts</span><span class="o">.</span><span class="no">User</span><span class="p">,</span> <span class="ss">:inserted</span><span class="p">)</span>
<span class="no">EctoWatch</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Accounts</span><span class="o">.</span><span class="no">User</span><span class="p">,</span> <span class="ss">:updated</span><span class="p">)</span>
<span class="no">EctoWatch</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Accounts</span><span class="o">.</span><span class="no">User</span><span class="p">,</span> <span class="ss">:deleted</span><span class="p">)</span>

<span class="no">EctoWatch</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Shipping</span><span class="o">.</span><span class="no">Package</span><span class="p">,</span> <span class="ss">:inserted</span><span class="p">)</span>
<span class="no">EctoWatch</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Shipping</span><span class="o">.</span><span class="no">Package</span><span class="p">,</span> <span class="ss">:updated</span><span class="p">)</span>
</code></pre></div></div>

<p>If your process just needs to get updates about a specific record an ID can be given:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">EctoWatch</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Accounts</span><span class="o">.</span><span class="no">Package</span><span class="p">,</span> <span class="ss">:updated</span><span class="p">,</span> <span class="n">package</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div></div>

<p>Then finally the module that implements your process (LiveView, GenServer, etc…) can handle messages about records:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># LiveView example</span>
<span class="k">def</span> <span class="n">handle_info</span><span class="p">({</span><span class="ss">:inserted</span><span class="p">,</span> <span class="no">Accounts</span><span class="o">.</span><span class="no">User</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">_</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">Accounts</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
  <span class="n">socket</span> <span class="o">=</span> <span class="n">stream_insert</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:users</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">handle_info</span><span class="p">({</span><span class="ss">:updated</span><span class="p">,</span> <span class="no">Accounts</span><span class="o">.</span><span class="no">User</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">_</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">Accounts</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
  <span class="n">socket</span> <span class="o">=</span> <span class="n">stream_insert</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:users</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">handle_info</span><span class="p">({</span><span class="ss">:deleted</span><span class="p">,</span> <span class="no">Accounts</span><span class="o">.</span><span class="no">User</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">_</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">Accounts</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
  <span class="n">socket</span> <span class="o">=</span> <span class="n">stream_delete</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:users</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can also define which columns trigger messages on updates as well as which values (in addition to the ID) to send with messages. Definitely check out the <a href="https://github.com/cheerfulstoic/ecto_watch">repo’s README</a> for more details on how to use EctoWatch!</p>

<p>Conclusion</p>

<p>I believe that <a href="https://github.com/cheerfulstoic/ecto_watch">EctoWatch</a> can be a powerful new way to simplify how we deal with database changes. Allowing a quick configuration of watchers and using simple message passing with Phoenix PubSub, you can separate the concern of <strong>making a change</strong> from the concern of <strong>what happens as a result</strong> of the change. This allows your code to be more easily readable and refactorable.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags</strong>
    <span itemprop="keywords">
    
      <a href="/tags/#elixir" class="page__taxonomy-item" rel="tag">elixir</a>
    
    </span>
  </p>





        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2024-06-27T00:00:00+02:00">June 27, 2024</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/elixir/2023/08/02/brian-test" class="pagination--pager" title="Brian Nutshell Test
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 brian-underwood.blogs. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  
    <script src="/assets/prism.js"></script>
  










  </body>
</html>
